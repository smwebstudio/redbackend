option_settings:
  - namespace: aws:elasticbeanstalk:application:environment
    option_name: COMPOSER_HOME
    value: /root

container_commands:
  01_install_composer_dependencies:
    command: "sudo php -d memory_limit=-1 /usr/bin/composer.phar install --no-interaction --prefer-dist --optimize-autoloader"
    cwd: "/var/app/staging"

  02_run_bootstrap_command:
    command: "php artisan horizon:terminate"
    cwd: "/var/app/staging"

  03_install_node_dependencies:
    command: "sudo npm install"
    cwd: "/var/app/staging"

  04_build_node_assets:
    command: "sudo npm run production"
    cwd: "/var/app/staging"

  05_run_migrations:
    command: "php artisan migrate --force"
    cwd: "/var/app/staging"
    leader_only: true


#  05_run_seederss:
#     command: "php artisan db:seed --force"
#     cwd: "/var/app/staging"
#     leader_only: true


  06_run_bootstrap_command:
     command: "chmod -R 775 storage"
     cwd: "/var/app/staging"

  07_run_bootstrap_command:
     command: "chmod -R 775 bootstrap/cache"
     cwd: "/var/app/staging"



files:
    /etc/systemd/system/laravel_horizon.service:
        mode: "000644"
        owner: root
        group: root
        content: |
            [Unit]
            Description=Laravel horizon

            [Service]
            User=webapp
            Group=webapp
            Restart=always
            EnvironmentFile=/opt/elasticbeanstalk/deployment/env
            ExecStart=/usr/bin/nohup /usr/bin/php /var/app/current/artisan horizon

            [Install]
            WantedBy=multi-user.target
    /etc/systemd/system/laravel_schedule.service:
            mode: "000644"
            owner: root
            group: root
            content: |
                [Unit]
                Description=Laravel schedule

                [Service]
                User=webapp
                Group=webapp
                Restart=always
                EnvironmentFile=/opt/elasticbeanstalk/deployment/env
                ExecStart=/usr/bin/nohup /usr/bin/php /var/app/current/artisan schedule:run

                [Install]
                WantedBy=multi-user.target
commands:
  remove_horizon_bak_file:
    command: "rm -f /etc/systemd/system/laravel_horizon.service.bak"
  remove_schedule_bak_file:
      command: "rm -f /etc/systemd/system/laravel_schedule.service.bak"
